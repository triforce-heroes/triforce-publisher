import{existsSync as e,readFileSync as s,writeFileSync as t}from"node:fs";import{fatal as n}from"@triforce-heroes/triforce-core/Console";import{getEngine as a}from"../database/EngineDatabase.js";import{getEntries as r,updateEntries as l}from"../database/EntryDatabase.js";import{getEntryHash as o}from"../utils/HashUtils.js";import{isSame as i}from"../utils/ObjectUtils.js";export async function PublishCommand(u,d){e("./publishable.json")||n("No publishable.ts found"),process.stdout.write("Reading publishable entries... ");let c=JSON.parse(s("./publishable.json","utf8"));process.stdout.write("OK\n"),d.dryRun||null!==await a(u)||n(`Engine not found: ${u}`);let p=new Map((await r(u,d.testRun)).map(e=>[e.index,e])),f=[],m=new Map,x=new Map,b=0,h=0,y=Date.now();for(let e of c){let s=p.get(e.index);if(void 0===s&&d.testRun)continue;let t=o(e),n=m.get(t);void 0===n&&m.set(t,e.index);let a=JSON.stringify({...e.sources}),r=x.get(a);void 0===r&&x.set(a,e.index);let l=void 0!==n||r!==n,c={engine:u,index:e.index,resource:e.resource,reference:e.reference,context:e.context,sources:l?{}:e.sources,translations:l?{}:e.translations,sourceIndex:l?null:e.sourceIndex,translationIndex:l?null:e.translationIndex,translatedBy:e.translatedBy??null,translatedAt:e.translatedAt??null,same:n??null,sameSources:void 0!==r&&r!==n?r:null};if(null===c.same&&null===c.sameSources){if(null===c.translatedBy){if("string"!=typeof c.sourceIndex||/[a-z]/i.test(c.sourceIndex)){if(void 0!==c.sources&&1===Object.keys(c.sources).length)c.translationIndex=c.sourceIndex,c.translatedBy=16,c.translatedAt=y,h++;else if(void 0!==c.sources&&void 0!==c.translations)for(let[e,s]of Object.entries(c.sources)){let t=e.split(",");if(t.includes("en")&&t.includes("es")&&s===c.translations[e]){c.translationIndex=c.sourceIndex,c.translatedBy=16,c.translatedAt=y,h++;break}}}else c.translationIndex=c.sourceIndex,c.translatedBy=16,c.translatedAt=y,h++}}else b++;void 0===s?f.push(c):null!==c.translatedBy&&c.translatedBy!==s.translatedBy&&null===s.translatedBy?f.push(c):null!==c.same&&c.same!==s.same?f.push(c):null!==c.sameSources&&c.sameSources!==s.sameSources?f.push(c):null!==c.same||(c.sourceIndex!==s.sourceIndex?f.push(c):i(c.sources,s.sources)&&i(c.translations,s.translations)||f.push(c))}if(t("./publishable-unfiltered.json",JSON.stringify(f,null,2)),!d.dryRun)for(let e=0;e<f.length;e+=1e3)await l(u,f.slice(e,e+1e3));function g(e,s){process.stdout.write(`
 ${e>=0?" ":"-"} ${String(e).padStart(5," ")}    ${s}`)}process.stdout.write(`
ENTRIES:`),g(c.length,"TOTAL"),g(b,"(Duplicates)"),g(h,'(Keep "as-is")'),process.stdout.write(`
 ---------`),g(c.length-b-h,"SUBTOTAL"),process.stdout.write("\n\nDONE!\n")}